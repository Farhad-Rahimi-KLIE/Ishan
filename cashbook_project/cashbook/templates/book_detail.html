{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    /* Reset default margins and ensure no gap */
    body {
        margin: 0;
        padding: 0;
    }
    /* Navbar styles */
    .navbar-custom {
        background: linear-gradient(135deg, #343a40, #495057);
        color: white;
        padding: 10px 15px;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        margin: 0;
    }
    .navbar-custom .back-arrow {
        font-size: 1.5rem;
        color: white;
        text-decoration: none;
        margin-right: 15px;
    }
    .navbar-custom .book-title-container {
        flex-grow: 1;
    }
    .navbar-custom .book-title {
        font-size: 1.8rem; /* Larger font for book name */
        font-weight: bold;
        margin: 0;
    }
    .navbar-custom .book-creator {
        font-size: 0.9rem; /* Smaller font for creator */
        color: #adb5bd;
        margin: 0;
    }
    .navbar-custom .nav-icons a {
        color: white;
        margin-left: 15px;
        font-size: 1.2rem;
        text-decoration: none;
    }
    .navbar-custom .nav-icons a:hover {
        color: #adb5bd;
    }
    /* Summary card styles */
    .summary-card {
        background-color: #343a40; /* Dark background */
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        color: white;
    }
    .summary-card .summary-row {
        display: flex;
        justify-content: space-between;
        margin: 8px 0;
        font-size: 1rem;
    }
    .summary-card .summary-label {
        color: #ffffff; /* White text for labels */
    }
    .summary-card .summary-value.net-balance {
        color: #ffffff; /* White text for Net Balance value */
    }
    .summary-card .summary-value.cash-in {
        color: #28a745; /* Green text for Cash In value */
        font-weight: bold;
    }
    .summary-card .summary-value.cash-out {
        color: #dc3545; /* Red text for Cash Out value */
        font-weight: bold;
    }
    /* Horizontal filter scroll */
    .filter-container {
        display: flex;
        overflow-x: auto;
        white-space: nowrap;
        padding: 10px 0;
        scrollbar-width: thin;
    }
    .filter-container::-webkit-scrollbar {
        height: 8px;
    }
    .filter-container::-webkit-scrollbar-thumb {
        background: #6c757d;
        border-radius: 4px;
    }
    .filter-item {
        flex: 0 0 auto;
        margin-right: 10px;
        min-width: 160px;
    }
    .filter-item label {
        font-size: 0.9rem;
        margin-bottom: 5px;
    }
    .filter-item select, .filter-item input {
        font-size: 0.85rem;
        padding: 5px;
    }
    /* Table container */
    .table-container {
        margin-bottom: 60px; /* Space for fixed buttons */
        overflow-x: auto;
    }
    /* Responsive table */
    #cashbook-table {
        font-size: 0.85rem;
    }
    #cashbook-table th, #cashbook-table td {
        padding: 8px;
        white-space: nowrap;
    }
    #cashbook-table .cash-in {
        color: #28a745 !important;
    }
    #cashbook-table .cash-out {
        color: #dc3545 !important;
    }
    /* Bottom fixed buttons */
    .bottom-buttons {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        z-index: 1000;
        height: 50px;
    }
    .bottom-buttons .btn {
        flex: 1;
        border-radius: 0;
        font-size: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0;
    }
    .bottom-buttons .bg-cash-in {
        background: linear-gradient(135deg, #28a745, #34c759);
        color: white;
    }
    .bottom-buttons .bg-cash-out {
        background: linear-gradient(135deg, #dc3545, #ff6b6b);
        color: white;
    }
    /* Mobile-specific adjustments */
    @media (max-width: 576px) {
        .navbar-custom .book-title {
            font-size: 1.4rem;
        }
        .navbar-custom .book-creator {
            font-size: 0.8rem;
        }
        .navbar-custom .nav-icons a {
            font-size: 1rem;
            margin-left: 10px;
        }
        .filter-item {
            min-width: 120px;
        }
        .filter-item label {
            font-size: 0.8rem;
        }
        .filter-item select, .filter-item input {
            font-size: 0.75rem;
            padding: 4px;
        }
        .summary-card .summary-row {
            font-size: 0.9rem;
        }
        .bottom-buttons .btn {
            font-size: 0.9rem;
        }
        .table-container {
            margin-bottom: 50px;
        }
    }
</style>

<div class="container mt-0">
    <!-- Custom Navbar -->
    <div class="navbar-custom">
        <a href="{% url 'homepage' %}" class="back-arrow"><i class="bi bi-arrow-left"></i></a>
        <div class="book-title-container">
            <div class="book-title">{{ book.name }}</div>
            <div class="book-creator">Created by {{ book.created_by.username }}</div>
        </div>
        <div class="nav-icons">
            {% if can_generate_report %}
                <a href="{% url 'generate_report' book.id %}" title="Generate Report"><i class="bi bi-file-earmark-text"></i></a>
            {% endif %}
            {% if is_book_admin %}
                <a href="{% url 'create_user_for_book' book.id %}" title="Create User"><i class="bi bi-person-plus"></i></a>
            {% endif %}
        </div>
    </div>

    <!-- Filter Form with Horizontal Scroll -->
    <form method="get" class="mb-3" id="filter-form">
        <div class="filter-container">
            <div class="filter-item">
                <label for="date_filter" class="form-label">Date Filter</label>
                <select name="date_filter" id="date_filter" class="form-select">
                    <option value="" {% if not date_filter %}selected{% endif %}>All Time</option>
                    <option value="today" {% if date_filter == 'today' %}selected{% endif %}>Today</option>
                    <option value="yesterday" {% if date_filter == 'yesterday' %}selected{% endif %}>Yesterday</option>
                    <option value="this_month" {% if date_filter == 'this_month' %}selected{% endif %}>This Month</option>
                    <option value="last_month" {% if date_filter == 'last_month' %}selected{% endif %}>Last Month</option>
                    <option value="custom" {% if date_filter == 'custom' %}selected{% endif %}>Custom Range</option>
                </select>
                <div id="date-range-inputs" style="display: {% if date_filter == 'custom' %}block{% else %}none{% endif %};">
                    <label for="start_date" class="form-label">Start Date</label>
                    <input type="date" name="start_date" id="start_date" value="{% if date_filter == 'custom' %}{{ request.GET.start_date|default_if_none:'' }}{% endif %}" class="form-control">
                    <label for="end_date" class="form-label">End Date</label>
                    <input type="date" name="end_date" id="end_date" value="{% if date_filter == 'custom' %}{{ request.GET.end_date|default_if_none:'' }}{% endif %}" class="form-control">
                </div>
            </div>
            <div class="filter-item">
                <label for="category" class="form-label">Category</label>
                <select name="category" id="category" class="form-select">
                    <option value="" {% if not request.GET.category %}selected{% endif %}>All Categories</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}" {% if request.GET.category == category.id|stringformat:"s" %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-item">
                <label for="type" class="form-label">Type</label>
                <select name="type" id="type" class="form-select">
                    <option value="" {% if not request.GET.type %}selected{% endif %}>All Types</option>
                    <option value="IN" {% if request.GET.type == 'IN' %}selected{% endif %}>Cash In</option>
                    <option value="OUT" {% if request.GET.type == 'OUT' %}selected{% endif %}>Cash Out</option>
                </select>
            </div>
        </div>
    </form>

    <!-- Summary Card -->
    <div class="summary-card">
        <div class="summary-row">
            <span class="summary-label fw-bold">Net Balance</span>
            <span class="summary-value net-balance">{{ net_balance|floatformat:2 }}</span>
        </div>
        <div class="summary-row">
            <span class="summary-label fw-bold">Total In (+)</span>
            <span class="summary-value cash-in">{{ cash_in|floatformat:2 }}</span>
        </div>
        <div class="summary-row">
            <span class="summary-label fw-bold">Total Out (-)</span>
            <span class="summary-value cash-out">{{ cash_out|floatformat:2 }}</span>
        </div>
    </div>

    <!-- Entries Table -->
    {% if entry_data %}
        <div class="table-container">
            <table class="table table-striped table-hover table-bordered" id="cashbook-table">
                <thead class="table-dark">
                    <tr>
                        <th scope="col" data-sort="date">Date</th>
                        <th scope="col" data-sort="type">Type</th>
                        <th scope="col" data-sort="amount">Amount</th>
                        <!-- <th scope="col" data-sort="category">Category</th> -->
                        <!-- <th scope="col" data-sort="remarks">Remarks</th> -->
                        <th scope="col" data-sort="balance">Running Balance</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry, serialized_entry, running_balance in entry_data %}
                        <tr class="entry-row" data-entry='{{ serialized_entry|safe }}'>
                            <td>{{ entry.date }}<br>{{ entry.time }}</td>
                            <td class="{% if entry.transaction_type == 'IN' %}cash-in{% else %}cash-out{% endif %}">
                                {{ entry.get_transaction_type_display }}
                            </td>
                            <td class="{% if entry.transaction_type == 'IN' %}cash-in{% else %}cash-out{% endif %}">
                                {{ entry.amount|floatformat:2 }}
                            </td>
                            <!-- <td>{{ entry.category.name|default:"N/A" }}</td> -->
                            <!-- <td>{{ entry.remarks|default:"N/A" }}</td> -->
                            <td class="{% if running_balance >= 0 %}cash-in{% else %}cash-out{% endif %}">
                                {{ running_balance|floatformat:2 }}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>No entries found for this book.</p>
    {% endif %}

    <!-- Cash In/Out Buttons at Bottom -->
    {% if can_add_entry %}
        <div class="bottom-buttons">
            <a href="{% url 'add_entry' book_id=book.id transaction_type='IN' %}" class="btn bg-cash-in"> + CASH IN</a>
            <a href="{% url 'add_entry' book_id=book.id transaction_type='OUT' %}" class="btn bg-cash-out"> - CASH OUT</a>
        </div>
    {% endif %}

    <!-- Entry Details Modal -->
    <div class="modal fade" id="entryModal" tabindex="-1" aria-labelledby="entryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="entryModalLabel">Entry Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Date:</strong> <span id="modal-date"></span></p>
                    <p><strong>Time:</strong> <span id="modal-time"></span></p>
                    <p><strong>Type:</strong> <span id="modal-type"></span></p>
                    <p><strong>Amount:</strong> <span id="modal-amount"></span></p>
                    <p><strong>Category:</strong> <span id="modal-category"></span></p>
                    <p><strong>Remarks:</strong> <span id="modal-remarks"></span></p>
                    <p><strong>Optional Field:</strong> <span id="modal-optional"></span></p>
                    <p><strong>Created By:</strong> <span id="modal-user"></span></p>
                    <p><strong>Created At:</strong> <span id="modal-created"></span></p>
                    <div id="modal-image-container">
                        <strong>Bill Image:</strong>
                        <img id="modal-image" src="" alt="No image available" class="img-fluid" style="max-width: 100%;">
                    </div>
                    <p><strong>Running Balance:</strong> <span id="modal-running-balance"></span></p>
                </div>
                <div class="modal-footer">
                    {% if is_book_admin or can_add_entry %}
                        <a id="edit-entry-btn" href="#" class="btn btn-warning btn-sm">Edit</a>
                        <a id="delete-entry-btn" href="#" class="btn btn-danger btn-sm">Delete</a>
                    {% endif %}
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    if (typeof jQuery === 'undefined') {
        console.error('jQuery is not loaded. Please ensure jQuery is included.');
        alert('jQuery is not loaded. Please check the console for details.');
        return;
    }
    console.log('jQuery version:', jQuery.fn.jquery);

    // Modal click handler
    jQuery('.entry-row').on('click', function() {
        try {
            var entry = JSON.parse(this.getAttribute('data-entry'));
            console.log('Entry data:', entry);
            jQuery('#modal-date').text(entry.date || 'N/A');
            jQuery('#modal-time').text(entry.time || 'N/A');
            jQuery('#modal-type').text(entry.transaction_type || 'N/A');
            jQuery('#modal-amount').text(entry.amount || 'N/A');
            jQuery('#modal-category').text(entry.category || 'N/A');
            jQuery('#modal-remarks').text(entry.remarks || 'N/A');
            jQuery('#modal-optional').text(entry.optional_field || 'N/A');
            jQuery('#modal-user').text(entry.user || 'N/A');
            jQuery('#modal-created').text(entry.created_at || 'N/A');
            jQuery('#modal-running-balance').text(entry.running_balance || 'N/A');
            if (entry.image) {
                jQuery('#modal-image').attr('src', entry.image).show();
            } else {
                jQuery('#modal-image').hide();
            }
            var editUrl = "{% url 'edit_entry' book_id=book.id pk=0 %}".replace('0', entry.id);
            var deleteUrl = "{% url 'delete_entry' book_id=book.id pk=0 %}".replace('0', entry.id);
            jQuery('#edit-entry-btn').attr('href', editUrl);
            jQuery('#delete-entry-btn').attr('href', deleteUrl);
            jQuery('#entryModal').modal('show');
        } catch (e) {
            console.error('Error parsing entry data:', e);
            alert('Failed to load entry details. Check the console for errors.');
        }
    });

    // Get current URL parameters
    function getUrlParameter(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name) || '';
    }

    // Handle filter changes
    jQuery('#date_filter, #category, #type, #start_date, #end_date').on('change', function(event) {
        const filterId = this.id;
        const newValue = this.value;
        const currentValue = getUrlParameter(filterId);
        console.log(`Filter changed: ${filterId}, New Value: '${newValue}', Current URL Value: '${currentValue}'`);
        const form = jQuery('#filter-form');
        if (filterId === 'category') {
            console.log('Submitting form for category with value:', newValue);
            form.submit();
        } else if (newValue !== currentValue) {
            console.log('Submitting form for', filterId, 'with value:', newValue);
            if (filterId === 'date_filter' && newValue !== 'custom') {
                document.getElementById('start_date').value = '';
                document.getElementById('end_date').value = '';
            }
            form.submit();
        } else {
            console.log('No change in', filterId, 'value. Skipping form submission.');
        }
    });

    jQuery('#filter-form').on('submit', function(e) {
        console.log('Form submitted with data:', jQuery(this).serialize());
    });

    const categorySelect = document.getElementById('category');
    const urlCategory = getUrlParameter('category');
    if (categorySelect.value !== urlCategory) {
        console.log(`Category mismatch: DOM value '${categorySelect.value}', URL value '${urlCategory}'. Correcting to URL value.`);
        categorySelect.value = urlCategory;
    }

    // Toggle date range inputs
    function toggleDateRangeInputs() {
        const dateFilter = document.getElementById('date_filter').value;
        const dateRangeInputs = document.getElementById('date-range-inputs');
        if (dateFilter === 'custom') {
            dateRangeInputs.style.display = 'block';
        } else {
            dateRangeInputs.style.display = 'none';
            document.getElementById('start_date').value = '';
            document.getElementById('end_date').value = '';
        }
    }
    toggleDateRangeInputs();
    document.getElementById('date_filter').addEventListener('change', toggleDateRangeInputs);

    // Table sorting
    const getCellValue = (tr, idx) => tr.children[idx].innerText || tr.children[idx].textContent;
    const comparer = (idx, asc) => (a, b) => ((v1, v2) =>
        v1 !== '' && v2 !== '' && !isNaN(v1) && !isNaN(v2) ? v1 - v2 :
        v1.toString().localeCompare(v2)
    )(getCellValue(asc ? a : b, idx), getCellValue(asc ? b : a, idx));

    document.querySelectorAll('#cashbook-table th[data-sort]').forEach(th => {
        th.addEventListener('click', () => {
            const tbody = th.closest('table').querySelector('tbody');
            const idx = Array.from(th.parentNode.children).indexOf(th);
            const asc = !(th.dataset.asc === 'true');
            th.dataset.asc = asc;
            Array.from(tbody.querySelectorAll('tr'))
                .sort(comparer(idx, asc))
                .forEach(tr => tbody.appendChild(tr));
        });
    });
});
</script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
{% endblock %}