{% extends 'base.html' %}
{% load static %}

{% block content %}

<style>
    /* Inline custom styles for gradients since Bootstrap doesn't provide them */
    .bg-cash-in {
        background: linear-gradient(135deg, #28a745, #34c759);
        color: white;
    }
    .bg-cash-out {
        background: linear-gradient(135deg, #dc3545, #ff6b6b);
        color: white;
    }
    .bg-net-positive {
        background: linear-gradient(135deg, #007bff, #4dabf7);
        color: white;
    }
    .bg-net-negative {
        background: linear-gradient(135deg, #ff073a, #ff4d6d);
        color: white;
    }
    .table .cash-in {
        color: #28a745 !important; /* Green for Cash In and positive values in table */
    }
    .table .cash-out {
        color: #dc3545 !important; /* Red for Cash Out and negative values in table */
    }
    .cash-in {
        color: #28a745; /* Green for inline <p> */
    }
    .cash-out {
        color: #dc3545; /* Red for inline <p> */
    }
</style>

<div class="container mt-2">
    <h2>{{ book.name }}</h2>

    {% comment %} <p>Cash In: <span class="cash-in">{{ cash_in }}</span> | Cash Out: <span class="cash-out">{{ cash_out }}</span> | Net Balance: <span class="{% if net_balance >= 0 %}cash-in{% else %}cash-out{% endif %}">{{ net_balance }}</span></p> {% endcomment %}
   
    
      <p class="mb-4">
        Cash In: <span class="cash-in">{{ cash_in|floatformat:2 }}</span> |
        Cash Out: <span class="cash-out">{{ cash_out|floatformat:2 }}</span> |
        Net Balance: <span class="{% if net_balance >= 0 %}cash-in{% else %}cash-out{% endif %}">{{ net_balance|floatformat:2 }}</span>
    </p>


    <!-- Action Buttons -->
    {% if is_book_admin %}
    <div class="mb-3 mt-2">
        <a href="{% url 'generate_report' book.id %}" class="btn btn-primary">Generate Report</a>
        {% comment %} <a href="{% url 'invite_member' book.id %}" class="btn btn-success">Invite Member</a> {% endcomment %}
        <a href="{% url 'create_user_for_book' book.id %}" class="btn btn-info">Create User</a>
        <a href="{% url 'manage_users_for_book' book.id %}" class="btn btn-primary">Manage Users</a>

    </div>
    {% endif %}
    {% if can_add_entry %}
    <div class="mb-3">
        <a href="{% url 'add_entry' book_id=book.id transaction_type='IN' %}" class="btn btn-success">Cash In</a>
        <a href="{% url 'add_entry' book_id=book.id transaction_type='OUT' %}" class="btn btn-danger">Cash Out</a>
    </div>
    {% endif %}
    
    <!-- Filter Form -->
    <form method="get" class="mb-3">
        <div class="row">
            <div class="col-md-3">
                <label for="date" class="form-label">Filter by Date</label>
                <input type="date" name="date" id="date" class="form-control" value="{{ request.GET.date }}">
            </div>
            <div class="col-md-3">
                <label for="category" class="form-label">Filter by Category</label>
                <select name="category" id="category" class="form-control">
                    <option value="">All Categories</option>
                    {% for cat in categories %}
                        <option value="{{ cat.id }}" {% if request.GET.category == cat.id|stringformat:"s" %}selected{% endif %}>{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="type" class="form-label">Filter by Type</label>
                <select name="type" id="type" class="form-control">
                    <option value="">All Types</option>
                    <option value="IN" {% if request.GET.type == "IN" %}selected{% endif %}>Cash In</option>
                    <option value="OUT" {% if request.GET.type == "OUT" %}selected{% endif %}>Cash Out</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="search" class="form-label">Search</label>
                <input type="text" name="search" id="search" class="form-control" value="{{ search_query }}" placeholder="Search remarks or amount">
            </div>
        </div>
        <button type="submit" class="btn btn-primary mt-3">Apply Filters</button>
        <a href="{% url 'book_detail' book.id %}" class="btn btn-secondary mt-3">Clear Filters</a>
    </form>
{% comment %} 
     {% if is_book_admin %}
    <a href="{% url 'create_user_for_book' book.id %}" class="btn btn-primary">Add User to Book</a>
    {% endif %} {% endcomment %}
    
    
    <!-- Entries Table -->
    {% if page_obj %}
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Amount</th>
                    <th>Category</th>
                    <th>Remarks</th>
                    <th>Running Balance</th>
                </tr>
            </thead>
            <tbody>
                {% for entry, serialized_entry, running_balance in entry_data %}
                    <tr class="entry-row" data-entry='{{ serialized_entry|safe }}'>
                        <td>{{ entry.date }}</td>
                        <td class="{% if entry.transaction_type == 'IN' %} cash-in {% else %} cash-out {% endif %}">
                            {{ entry.get_transaction_type_display }}
                        </td>
                        <td class="{% if entry.transaction_type == 'IN' %}cash-in{% else %}cash-out{% endif %}">
                            {{ entry.amount|floatformat:2 }}
                        </td>
                        <td>{{ entry.category.name|default:"N/A" }}</td>
                        <td>{{ entry.remarks|default:"N/A" }}</td>
                        <td >
                            {{ running_balance|floatformat:2 }}
                        </td>
                    </tr>
                {% endfor %}
                {% comment %} {% for entry, serialized_entry, running_balance in entry_data %}
                    <tr class="entry-row" data-entry='{{ serialized_entry|safe }}'>
                        <td>{{ entry.date }}</td>
                        <td class="{% if entry.transaction_type == 'IN' %}cash-in{% else %}cash-out{% endif %}">{{ entry.get_transaction_type_display }}</td>
                        <td>{{ entry.amount }}</td>
                        <td>{{ entry.category.name|default:"N/A" }}</td>
                        <td>{{ entry.remarks|default:"N/A" }}</td>
                        <td class="{% if running_balance >= 0 %}cash-in{% else %}cash-out{% endif %}">{{ running_balance }}</td>
                    </tr>
                {% endfor %} {% endcomment %}
            </tbody>
        </table>
        <!-- Pagination -->
        <div class="pagination">
            <span class="step-links">
                {% if page_obj.has_previous %}
                    <a href="?page=1{% if request.GET.date %}&date={{ request.GET.date }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">« first</a>
                    <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.date %}&date={{ request.GET.date }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">previous</a>
                {% endif %}
                <span class="current">
                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
                </span>
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if request.GET.date %}&date={{ request.GET.date }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">next</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.date %}&date={{ request.GET.date }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">last »</a>
                {% endif %}
            </span>
        </div>
    {% else %}
        <p>No entries found for this book.</p>
    {% endif %}
    
    <!-- Entry Details Modal -->
    <div class="modal fade" id="entryModal" tabindex="-1" aria-labelledby="entryModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="entryModalLabel">Entry Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Date:</strong> <span id="modal-date"></span></p>
                    <p><strong>Time:</strong> <span id="modal-time"></span></p>
                    <p><strong>Type:</strong> <span id="modal-type"></span></p>
                    <p><strong>Amount:</strong> <span id="modal-amount"></span></p>
                    <p><strong>Category:</strong> <span id="modal-category"></span></p>
                    <p><strong>Remarks:</strong> <span id="modal-remarks"></span></p>
                    <p><strong>Optional Field:</strong> <span id="modal-optional"></span></p>
                    <p><strong>Created By:</strong> <span id="modal-user"></span></p>
                    <p><strong>Created At:</strong> <span id="modal-created"></span></p>
                    <div id="modal-image-container">
                        <strong>Bill Image:</strong>
                        <img id="modal-image" src="" alt="No image available" class="img-fluid" style="max-width: 100%;">
                    </div>
                    <p><strong>Running Balance:</strong> <span id="modal-running-balance"></span></p>
                </div>
                <div class="modal-footer">
                    {% if is_book_admin or entry.user == user or can_add_entry %}
                        <a id="edit-entry-btn" href="#" class="btn btn-warning">Edit</a>
                        <a id="delete-entry-btn" href="#" class="btn btn-danger">Delete</a>
                    {% endif %}
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <a href="{% url 'homepage' %}" class="btn btn-secondary mt-3">Back to Home</a>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    if (typeof jQuery === 'undefined') {
        console.error('jQuery is not loaded. Please ensure jQuery is included.');
        alert('jQuery is not loaded. Please check the console for details.');
        return;
    }
    console.log('jQuery version:', jQuery.fn.jquery);

    jQuery('.entry-row').on('click', function() {
        try {
            var entry = JSON.parse(this.getAttribute('data-entry'));
            console.log('Entry data:', entry); // Debug: Log entry data
            jQuery('#modal-date').text(entry.date || 'N/A');
            jQuery('#modal-time').text(entry.time || 'N/A');
            jQuery('#modal-type').text(entry.transaction_type || 'N/A');
            jQuery('#modal-amount').text(entry.amount || 'N/A');
            jQuery('#modal-category').text(entry.category || 'N/A');
            jQuery('#modal-remarks').text(entry.remarks || 'N/A');
            jQuery('#modal-optional').text(entry.optional_field || 'N/A');
            jQuery('#modal-user').text(entry.user || 'N/A');
            jQuery('#modal-created').text(entry.created_at || 'N/A');
            jQuery('#modal-running-balance').text(entry.running_balance || 'N/A');
            if (entry.image) {
                jQuery('#modal-image').attr('src', entry.image).show();
            } else {
                jQuery('#modal-image').hide();
            }
            // Update edit/delete buttons
            var editUrl = "{% url 'edit_entry' book_id=book.id pk=0 %}".replace('0', entry.id);
            var deleteUrl = "{% url 'delete_entry' book_id=book.id pk=0 %}".replace('0', entry.id);
            jQuery('#edit-entry-btn').attr('href', editUrl);
            jQuery('#delete-entry-btn').attr('href', deleteUrl);
            jQuery('#entryModal').modal('show');
        } catch (e) {
            console.error('Error parsing entry data:', e);
            alert('Failed to load entry details. Check the console for errors.');
        }
    });
});
</script>
{% endblock %}