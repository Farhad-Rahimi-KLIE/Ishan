{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    /* Inline custom styles for gradients */
    .bg-cash-in {
        background: linear-gradient(135deg, #28a745, #34c759);
        color: white;
    }
    .bg-cash-out {
        background: linear-gradient(135deg, #dc3545, #ff6b6b);
        color: white;
    }
    .bg-net-positive {
        background: linear-gradient(135deg, #007bff, #4dabf7);
        color: white;
    }
    .bg-net-negative {
        background: linear-gradient(135deg, #ff073a, #ff4d6d);
        color: white;
    }
    .table .cash-in {
        color: #28a745 !important; /* Green for Cash In */
    }
    .table .cash-out {
        color: #dc3545 !important; /* Red for Cash Out */
    }
    .cash-in {
        color: #28a745; /* Green for inline <p> */
    }
    .cash-out {
        color: #dc3545; /* Red for inline <p> */
    }
    /* Horizontal filter scroll */
    .filter-container {
        display: flex;
        overflow-x: auto;
        white-space: nowrap;
        padding-bottom: 10px;
        scrollbar-width: thin; /* Firefox */
    }
    .filter-container::-webkit-scrollbar {
        height: 8px; /* Chrome/Safari */
    }
    .filter-container::-webkit-scrollbar-thumb {
        background: #6c757d;
        border-radius: 4px;
    }
    .filter-item {
        flex: 0 0 auto;
        margin-right: 10px;
        min-width: 160px; /* Reduced for mobile */
    }
    /* Bottom fixed buttons */
    .bottom-buttons {
        position: fixed;
        bottom: 10px;
        left: 10px;
        right: 10px;
        display: flex;
        justify-content: space-between;
        z-index: 1000;
    }
    .bottom-buttons .btn {
        padding: 8px 16px; /* Smaller padding for mobile */
        font-size: 0.9rem; /* Smaller font */
    }
    /* Table container */
    .table-container {
        margin-bottom: 60px; /* Space for fixed buttons */
        overflow-x: auto; /* Horizontal scroll for table on mobile */
    }
    /* Responsive table */
    #cashbook-table {
        font-size: 0.85rem; /* Smaller font for mobile */
    }
    #cashbook-table th, #cashbook-table td {
        padding: 8px; /* Reduced padding */
        white-space: nowrap; /* Prevent text wrapping */
    }
    /* Mobile-specific adjustments */
    @media (max-width: 576px) {
        h2 {
            font-size: 1.5rem; /* Smaller heading */
        }
        .mb-4 {
            font-size: 0.9rem; /* Smaller summary text */
        }
        .filter-item {
            min-width: 120px; /* Even smaller for mobile */
        }
        .filter-item .form-label {
            font-size: 0.8rem;
        }
        .filter-item .form-select,
        .filter-item .form-control {
            font-size: 0.8rem;
            padding: 4px;
        }
        .bottom-buttons .btn {
            padding: 6px 12px;
            font-size: 0.8rem;
        }
        .table-container {
            margin-bottom: 50px;
        }
    }
</style>

<div class="container mt-2">
    <h2>{{ book.name }}</h2>
    
    <p class="mb-4">
        Cash In: <span class="cash-in">{{ cash_in|floatformat:2 }}</span> |
        Cash Out: <span class="cash-out">{{ cash_out|floatformat:2 }}</span> |
        Net Balance: <span class="{% if net_balance >= 0 %}cash-in{% else %}cash-out{% endif %}">{{ net_balance|floatformat:2 }}</span>
    </p>

    <div class="mb-3">
        {% if can_generate_report %}
            <a href="{% url 'generate_report' book.id %}" class="btn btn-primary btn-sm">Generate Report</a>
        {% endif %}
        {% if is_book_admin %}
            <a href="{% url 'create_user_for_book' book.id %}" class="btn btn-info btn-sm">Create User</a>
        {% endif %}
    </div>

    <!-- Filter Form with Horizontal Scroll -->
    <form method="get" class="mb-3" id="filter-form">
    <div class="filter-container">
        <div class="filter-item">
            <!-- <label for="date_filter" class="form-label">Filter by Date:</label> -->
            <select name="date_filter" id="date_filter" class="form-select">
                <option value="" {% if not date_filter %}selected{% endif %}>All Time</option>
                <option value="today" {% if date_filter == 'today' %}selected{% endif %}>Today</option>
                <option value="yesterday" {% if date_filter == 'yesterday' %}selected{% endif %}>Yesterday</option>
                <option value="this_month" {% if date_filter == 'this_month' %}selected{% endif %}>This Month</option>
                <option value="last_month" {% if date_filter == 'last_month' %}selected{% endif %}>Last Month</option>
                <option value="custom" {% if date_filter == 'custom' %}selected{% endif %}>Custom Range</option>
            </select>
            <div id="date-range-inputs" style="display: {% if date_filter == 'custom' %}block{% else %}none{% endif %};">
                <label for="start_date" class="form-label">Start Date:</label>
                <input type="date" name="start_date" id="start_date" value="{% if date_filter == 'custom' %}{{ start_date|default_if_none:'' }}{% endif %}" class="form-control">
                <label for="end_date" class="form-label">End Date:</label>
                <input type="date" name="end_date" id="end_date" value="{% if date_filter == 'custom' %}{{ end_date|default_if_none:'' }}{% endif %}" class="form-control">
            </div>
        </div>
        <div class="filter-item">
            <!-- <label for="category" class="form-label">Filter by Category</label> -->
            <select name="category" id="category" class="form-select">
              <option value="" {% if category_filter == '' or not category_filter %}selected{% endif %}>All Category</option>
                {% for category in categories %}
                    <option value="{{ category.id }}" {% if category_filter == category.id|stringformat:"s" %}selected{% endif %}>
                        {{ category.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-item">
            <!-- <label for="type" class="form-label">Filter by Type</label> -->
            <select name="type" id="type" class="form-select">
                <option value="" {% if not request.GET.type %}selected{% endif %}>All Types</option>
                <option value="IN" {% if request.GET.type == 'IN' %}selected{% endif %}>Cash In</option>
                <option value="OUT" {% if request.GET.type == 'OUT' %}selected{% endif %}>Cash Out</option>
            </select>
        </div>
    </div>
</form>

    <!-- Entries Table -->
    {% if page_obj %}
        <div class="table-container">
            <table class="table table-striped table-hover table-bordered" id="cashbook-table">
                <thead class="table-dark">
                    <tr>
                        <th scope="col" data-sort="date">Date</th>
                        <th scope="col" data-sort="type">Type</th>
                        <th scope="col" data-sort="amount">Amount</th>
                        <th scope="col" data-sort="category">Category</th>
                        <th scope="col" data-sort="remarks">Remarks</th>
                        <th scope="col" data-sort="balance">Running Balance</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry, serialized_entry, running_balance in entry_data %}
                        <tr class="entry-row" data-entry='{{ serialized_entry|safe }}'>
                            <td>{{ entry.date }}<br>{{ entry.time }}</td>
                            <td class="{% if entry.transaction_type == 'IN' %}cash-in{% else %}cash-out{% endif %}">
                                {{ entry.get_transaction_type_display }}
                            </td>
                            <td class="{% if entry.transaction_type == 'IN' %}cash-in{% else %}cash-out{% endif %}">
                                {{ entry.amount|floatformat:2 }}
                            </td>
                            <td>{{ entry.category.name|default:"N/A" }}</td>
                            <td>{{ entry.remarks|default:"N/A" }}</td>
                            <td class="{% if running_balance >= 0 %}cash-in{% else %}cash-out{% endif %}">
                                {{ running_balance|floatformat:2 }}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <!-- Pagination -->
           <div class="pagination mt-3">
    <span class="step-links">
        {% if page_obj.has_previous %}
            <a href="?page=1&date_filter={{ request.GET.date_filter|default_if_none:'' }}&start_date={{ request.GET.start_date|default_if_none:'' }}&end_date={{ request.GET.end_date|default_if_none:'' }}&category={{ request.GET.category|default_if_none:'' }}&type={{ request.GET.type|default_if_none:'' }}{% if search_query %}&search={{ search_query }}{% endif %}" class="btn btn-outline-primary btn-sm">« First</a>
            <a href="?page={{ page_obj.previous_page_number }}&date_filter={{ request.GET.date_filter|default_if_none:'' }}&start_date={{ request.GET.start_date|default_if_none:'' }}&end_date={{ request.GET.end_date|default_if_none:'' }}&category={{ request.GET.category|default_if_none:'' }}&type={{ request.GET.type|default_if_none:'' }}{% if search_query %}&search={{ search_query }}{% endif %}" class="btn btn-outline-primary btn-sm">Previous</a>
        {% endif %}
        <span class="current">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
        </span>
        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}&date_filter={{ request.GET.date_filter|default_if_none:'' }}&start_date={{ request.GET.start_date|default_if_none:'' }}&end_date={{ request.GET.end_date|default_if_none:'' }}&category={{ request.GET.category|default_if_none:'' }}&type={{ request.GET.type|default_if_none:'' }}{% if search_query %}&search={{ search_query }}{% endif %}" class="btn btn-outline-primary btn-sm">Next</a>
            <a href="?page={{ page_obj.paginator.num_pages }}&date_filter={{ request.GET.date_filter|default_if_none:'' }}&start_date={{ request.GET.start_date|default_if_none:'' }}&end_date={{ request.GET.end_date|default_if_none:'' }}&category={{ request.GET.category|default_if_none:'' }}&type={{ request.GET.type|default_if_none:'' }}{% if search_query %}&search={{ search_query }}{% endif %}" class="btn btn-outline-primary btn-sm">Last »</a>
        {% endif %}
    </span>
</div>
        </div>
    {% else %}
        <p>No entries found for this book.</p>
    {% endif %}

    <!-- Cash In/Out Buttons at Bottom -->
    {% if can_add_entry %}
        <div class="bottom-buttons">
            <a href="{% url 'add_entry' book_id=book.id transaction_type='IN' %}" class="btn bg-cash-in">Cash In</a>
            <a href="{% url 'add_entry' book_id=book.id transaction_type='OUT' %}" class="btn bg-cash-out">Cash Out</a>
        </div>
    {% endif %}

    <!-- Entry Details Modal -->
    <div class="modal fade" id="entryModal" tabindex="-1" aria-labelledby="entryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="entryModalLabel">Entry Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Date:</strong> <span id="modal-date"></span></p>
                    <p><strong>Time:</strong> <span id="modal-time"></span></p>
                    <p><strong>Type:</strong> <span id="modal-type"></span></p>
                    <p><strong>Amount:</strong> <span id="modal-amount"></span></p>
                    <p><strong>Category:</strong> <span id="modal-category"></span></p>
                    <p><strong>Remarks:</strong> <span id="modal-remarks"></span></p>
                    <p><strong>Optional Field:</strong> <span id="modal-optional"></span></p>
                    <p><strong>Created By:</strong> <span id="modal-user"></span></p>
                    <p><strong>Created At:</strong> <span id="modal-created"></span></p>
                    <div id="modal-image-container">
                        <strong>Bill Image:</strong>
                        <img id="modal-image" src="" alt="No image available" class="img-fluid" style="max-width: 100%;">
                    </div>
                    <p><strong>Running Balance:</strong> <span id="modal-running-balance"></span></p>
                </div>
                <div class="modal-footer">
                    {% if is_book_admin or entry.user == user or can_add_entry %}
                        <a id="edit-entry-btn" href="#" class="btn btn-warning btn-sm">Edit</a>
                        <a id="delete-entry-btn" href="#" class="btn btn-danger btn-sm">Delete</a>
                    {% endif %}
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <a href="{% url 'homepage' %}" class="btn btn-secondary btn-sm mt-3">Back to Home</a>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    if (typeof jQuery === 'undefined') {
        console.error('jQuery is not loaded. Please ensure jQuery is included.');
        alert('jQuery is not loaded. Please check the console for details.');
        return;
    }
    console.log('jQuery version:', jQuery.fn.jquery);


     // Modal click handler
    jQuery('.entry-row').on('click', function() {
        try {
            var entry = JSON.parse(this.getAttribute('data-entry'));
            console.log('Entry data:', entry);
            jQuery('#modal-date').text(entry.date || 'N/A');
            jQuery('#modal-time').text(entry.time || 'N/A');
            jQuery('#modal-type').text(entry.transaction_type || 'N/A');
            jQuery('#modal-amount').text(entry.amount || 'N/A');
            jQuery('#modal-category').text(entry.category || 'N/A');
            jQuery('#modal-remarks').text(entry.remarks || 'N/A');
            jQuery('#modal-optional').text(entry.optional_field || 'N/A');
            jQuery('#modal-user').text(entry.user || 'N/A');
            jQuery('#modal-created').text(entry.created_at || 'N/A');
            jQuery('#modal-running-balance').text(entry.running_balance || 'N/A');
            if (entry.image) {
                jQuery('#modal-image').attr('src', entry.image).show();
            } else {
                jQuery('#modal-image').hide();
            }
            var editUrl = "{% url 'edit_entry' book_id=book.id pk=0 %}".replace('0', entry.id);
            var deleteUrl = "{% url 'delete_entry' book_id=book.id pk=0 %}".replace('0', entry.id);
            jQuery('#edit-entry-btn').attr('href', editUrl);
            jQuery('#delete-entry-btn').attr('href', deleteUrl);
            jQuery('#entryModal').modal('show');
        } catch (e) {
            console.error('Error parsing entry data:', e);
            alert('Failed to load entry details. Check the console for errors.');
        }
    });

     // Get current URL parameters
    function getUrlParameter(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name) || '';
    }


    // Handle filter changes
    jQuery('#date_filter, #category, #type, #start_date, #end_date').on('change', function(event) {
        const filterId = this.id;
        const newValue = this.value;
        const currentValue = getUrlParameter(filterId);
        console.log(`Filter changed: ${filterId}, New Value: '${newValue}', Current URL Value: '${currentValue}'`);

         const form = jQuery('#filter-form');
        if (filterId === 'category') {
            console.log('Submitting form for category with value:', newValue);
            form.submit();
        } else if (newValue !== currentValue) {
            console.log('Submitting form for', filterId, 'with value:', newValue);
            // Clear date inputs for non-custom date filters
            if (filterId === 'date_filter' && newValue !== 'custom') {
                document.getElementById('start_date').value = '';
                document.getElementById('end_date').value = '';
            }
            form.submit();
        } else {
            console.log('No change in', filterId, 'value. Skipping form submission.');
        }
    });

    
    jQuery('#filter-form').on('submit', function(e) {
        console.log('Form submitted with data:', jQuery(this).serialize());
    });

     const categorySelect = document.getElementById('category');
    const urlCategory = getUrlParameter('category');
    if (categorySelect.value !== urlCategory) {
        console.log(`Category mismatch: DOM value '${categorySelect.value}', URL value '${urlCategory}'. Correcting to URL value.`);
        categorySelect.value = urlCategory;
    }

    // Toggle date range inputs
   function toggleDateRangeInputs() {
    const dateFilter = document.getElementById('date_filter').value;
    const dateRangeInputs = document.getElementById('date-range-inputs');
    if (dateFilter === 'custom') {
      dateRangeInputs.style.display = 'block';
    } else {
      dateRangeInputs.style.display = 'none';
        document.getElementById('start_date').value = '';
        document.getElementById('end_date').value = '';
        // document.getElementById('filter-form').submit();
    }
   }
  toggleDateRangeInputs();


    // Table sorting
    const getCellValue = (tr, idx) => tr.children[idx].innerText || tr.children[idx].textContent;
    const comparer = (idx, asc) => (a, b) => ((v1, v2) =>
        v1 !== '' && v2 !== '' && !isNaN(v1) && !isNaN(v2) ? v1 - v2 :
        v1.toString().localeCompare(v2)
    )(getCellValue(asc ? a : b, idx), getCellValue(asc ? b : a, idx));

    document.querySelectorAll('#cashbook-table th[data-sort]').forEach(th => {
        th.addEventListener('click', () => {
            const tbody = th.closest('table').querySelector('tbody');
            const idx = Array.from(th.parentNode.children).indexOf(th);
            const asc = !(th.dataset.asc === 'true');
            th.dataset.asc = asc;
            Array.from(tbody.querySelectorAll('tr'))
                .sort(comparer(idx, asc))
                .forEach(tr => tbody.appendChild(tr));
        });
    });
});

</script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
{% endblock %}