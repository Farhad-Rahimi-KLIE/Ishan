{% extends 'base.html' %}
{% load group_filters %}  <!-- Add this to load the custom filter -->

{% block content %}
<div class="container mt-4 cashbook-container">
    <!-- {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %} -->

    {% if books_with_balance %}
        <div class="table-responsive">
            <table class="table table-striped cashbook-table">
                <thead class="table-dark col-sm-5">
                    <tr>
                        <th>Name</th>
                        <th>Net Balance</th>
                        <th>Members</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in books_with_balance %}
                        <tr class="clickable-row" data-href="{% url 'book_detail' item.book.id %}">
                            <td>{{ item.book.name }}</td>
                            <td class="{% if item.net_balance >= 0 %}cash-in{% else %}cash-out{% endif %}">
                                {{ item.net_balance|floatformat:2|default:"0.00" }}
                            </td>
                            <td>{{ item.member_count|default:"0" }}</td>
                            <td class="actions-cell">
                                <div class="dropdown">
                                    <button class="btn btn-link text-dark dropdown-toggle" type="button" id="dropdownMenu-{{ item.book.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-ellipsis-v fa-lg"></i>
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="dropdownMenu-{{ item.book.id }}">
                                        {% if 'Admin' in user.groups.all|lookup:'name' or item.book.created_by == user %}
                                            <li>
                                                <a class="dropdown-item" href="{% url 'edit_book' item.book.id %}">Edit</a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item text-danger" href="{% url 'delete_book' item.book.id %}">Delete</a>
                                            </li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p class="text-center fw-bold text-primary fs-4 mb-0 transition" style="text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
          No Books Found
        </p>
    {% endif %}

    {% if 'Admin' in user.groups.all|lookup:'name' %}
        <a href="{% url 'add_book' %}" class="btn btn-primary btn-circle btn-add-book" title="Add New Book">
            <i class="fas fa-plus fa-lg"></i>
        </a>
    {% endif %}
</div>

<style>
.cashbook-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.cashbook-table {
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.cashbook-table th, .cashbook-table td {
    padding: 12px;
    text-align: center;
    vertical-align: middle;
}

.cashbook-table .cash-in {
    color: #28a745;
    font-weight: 500;
}

.cashbook-table .cash-out {
    color: #dc3545;
    font-weight: 500;
}

.clickable-row {
    cursor: pointer;
    transition: background-color 0.2s;
}

.clickable-row:hover {
    background-color: #f8f9fa;
}

.clickable-row td:not(.actions-cell) {
    pointer-events: auto;
}

.actions-cell {
    pointer-events: auto;
}

.btn-circle {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    background-color: #007bff;
    color: #fff !important;
    transition: background-color 0.3s;
}

.btn-circle:hover {
    background-color: #0056b3;
}

.btn-circle .fa-plus {
    color: #fff !important;
}

.user-info .fa-user-circle {
    color: #007bff !important;
}

.btn-link .fa-ellipsis-v {
    color: #343a40 !important;
    font-size: 1.2rem;
}

.btn-link:hover .fa-ellipsis-v {
    color: #007bff !important;
}

.dropdown-menu {
    min-width: 120px;
}

.dropdown-item.text-danger:hover {
    background-color: #f8d7da;
}

.dropdown-toggle::after {
    display: none;
    margin-left: .255em;
    vertical-align: .255em;
    content: "";
    border-top: .3em solid;
    border-right: .3em solid transparent;
    border-bottom: 0;
    border-left: .3em solid transparent;
}
@media (max-width: 576px) {
  .table-dark th {
    font-size: 0.8rem;
    padding: 0.5rem;
    text-align: center;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap dropdowns
    const dropdowns = document.querySelectorAll('[data-bs-toggle="dropdown"]');
    dropdowns.forEach(function(dropdown) {
        new bootstrap.Dropdown(dropdown);
    });
    console.log('Dropdowns initialized:', dropdowns.length);

    // Make table rows clickable except for the Actions column
    document.querySelectorAll('.clickable-row').forEach(function(row) {
        row.addEventListener('click', function(e) {
            // Prevent row click if clicking inside the Actions column
            if (!e.target.closest('.actions-cell')) {
                const href = this.getAttribute('data-href');
                if (href) {
                    window.location.href = href;
                }
            }
        });
    });
});
</script>
{% endblock %}